local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CollectionService = game:GetService("CollectionService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")

local player = Players.LocalPlayer
local client = require(player.PlayerScripts.Client)

local Window = Fluent:CreateWindow({
    Title = "Stronghold Timer Hub",
    SubTitle = "Live Countdown & Management",
    TabWidth = 160,
    Size = UDim2.fromOffset(480, 360),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

local MainTab = Window:AddTab({ Title = "Stronghold Timers", Icon = "castle" })

local strongholds = {}
local timerConnections = {}
local notifications = true
local autoTeleport = false
local selectedStronghold = nil
local skipTimerEnabled = false
local skipTimerThreshold = 0
local hasSkippedThisSession = false

local levelColors = {
    Color3.fromRGB(195, 255, 0),
    Color3.fromRGB(255, 238, 0),
    Color3.fromRGB(255, 157, 0),
    Color3.fromRGB(255, 64, 0),
    Color3.fromRGB(255, 0, 0)
}

local function convertTime(seconds)
    if seconds <= 0 then
        return "OPEN NOW!"
    elseif seconds <= 60 then
        return string.format("%02ds", math.floor(seconds))
    elseif seconds <= 3600 then
        return string.format("%02dm %02ds", math.floor(seconds / 60), math.floor(seconds % 60))
    else
        return string.format("%02dh %02dm", math.floor(seconds / 3600), math.floor((seconds % 3600) / 60))
    end
end

local function getLevelColor(level)
    return levelColors[level] or levelColors[5]
end

local function playNotificationSound()
    if notifications then
        client.Sound.Play("StrongholdEnter")
    end
end

local function createTimerDisplay(stronghold)
    local name = stronghold.Name
    local functional = stronghold:WaitForChild("Functional")
    
    strongholds[name] = {
        instance = stronghold,
        functional = functional,
        level = functional:GetAttribute("Level") or 1,
        openTime = functional:GetAttribute("OpenTime"),
        paragraph = nil,
        isOpen = false
    }
    
    local timerText = string.format("ðŸ° %s (Level %d) - Loading...", name, strongholds[name].level)
    strongholds[name].paragraph = MainTab:AddParagraph({
        Title = name,
        Content = timerText
    })
    
    local connection = functional:GetAttributeChangedSignal("OpenTime"):Connect(function()
        strongholds[name].openTime = functional:GetAttribute("OpenTime")
        strongholds[name].level = functional:GetAttribute("Level") or 1
    end)
    
    timerConnections[name] = connection
end

local function updateTimer(name)
    local stronghold = strongholds[name]
    if not stronghold or not stronghold.openTime then return end
    
    local timeRemaining = stronghold.openTime - workspace:GetServerTimeNow()
    local timeString = convertTime(timeRemaining)
    
    local statusIcon = timeRemaining <= 0 and "ðŸŸ¢" or "ðŸ”´"
    local levelText = string.format("Level %d", stronghold.level)
    
    if skipTimerEnabled and not hasSkippedThisSession and timeRemaining > skipTimerThreshold then
        hasSkippedThisSession = true
        local thresholdMinutes = math.floor(skipTimerThreshold / 60)
        local thresholdSeconds = skipTimerThreshold % 60
        
        Fluent:Notify({
            Title = "Skipping Stronghold",
            Content = string.format("Timer (%s) exceeds %02d:%02d threshold. Teleporting...", timeString, thresholdMinutes, thresholdSeconds),
            Duration = 3
        })
        
        task.wait(1)
        
        local success, error = pcall(function()
            TeleportService:Teleport(126509999114328)
        end)
        
        if not success then
            Fluent:Notify({
                Title = "Teleport Failed",
                Content = "Could not teleport: " .. tostring(error),
                Duration = 5
            })
        end
        
        return
    end
    
    if timeRemaining <= 0 and not stronghold.isOpen then
        stronghold.isOpen = true
        hasSkippedThisSession = false
        playNotificationSound()
        Fluent:Notify({
            Title = "Stronghold Open!",
            Content = string.format("%s is now available!", name),
            Duration = 5
        })
    elseif timeRemaining > 0 then
        stronghold.isOpen = false
    end
    
    local content = string.format("%s %s - %s\nâ° %s", statusIcon, levelText, name, timeString)
    stronghold.paragraph:SetDesc(content)
end

local function onStrongholdAdded(stronghold)
    if stronghold.Name ~= "AlienMothership" then
        task.spawn(function()
            createTimerDisplay(stronghold)
        end)
    end
end

local function onStrongholdRemoved(stronghold)
    local name = stronghold.Name
    if strongholds[name] then
        if timerConnections[name] then
            timerConnections[name]:Disconnect()
            timerConnections[name] = nil
        end
        strongholds[name] = nil
    end
end

-- Create UI elements first
local NotificationsToggle = MainTab:AddToggle("Notifications", {
    Title = "Enable Notifications",
    Description = "Get notified when strongholds open",
    Default = true,
    Callback = function(value)
        notifications = value
    end
})

local skipTimerOptions = {}
for minutes = 0, 20 do
    for seconds = 0, 59, 15 do
        if minutes == 0 and seconds == 0 then
            table.insert(skipTimerOptions, "Disabled")
        else
            local timeValue = minutes * 60 + seconds
            local displayText = string.format("%02d:%02d", minutes, seconds)
            table.insert(skipTimerOptions, displayText)
        end
        if minutes == 20 and seconds > 0 then break end
    end
end

local SkipTimerDropdown = MainTab:AddDropdown("SkipTimer", {
    Title = "Skip Stronghold Based on Timer",
    Description = "Teleport away if stronghold timer exceeds selected time",
    Values = skipTimerOptions,
    Multi = false,
    Default = 1,
    Callback = function(value)
        if value == "Disabled" then
            skipTimerEnabled = false
            skipTimerThreshold = 0
            hasSkippedThisSession = false
        else
            skipTimerEnabled = true
            local minutes, seconds = value:match("(%d+):(%d+)")
            skipTimerThreshold = tonumber(minutes) * 60 + tonumber(seconds)
            hasSkippedThisSession = false
            
            Fluent:Notify({
                Title = "Skip Timer Enabled",
                Content = string.format("Will teleport if timer exceeds %s", value),
                Duration = 3
            })
        end
    end
})

MainTab:AddButton({
    Title = "Reset Skip Status",
    Description = "Allow skip teleport to trigger again this session",
    Callback = function()
        hasSkippedThisSession = false
        Fluent:Notify({
            Title = "Skip Status Reset",
            Content = "Skip teleport can now trigger again",
            Duration = 3
        })
    end
})

local AutoTeleportToggle = MainTab:AddToggle("AutoTeleport", {
    Title = "Auto Teleport (Coming Soon)",
    Description = "Automatically teleport to open strongholds",
    Default = false,
    Callback = function(value)
        autoTeleport = value
        if value then
            Fluent:Notify({
                Title = "Feature Coming Soon",
                Content = "Auto teleport will be available in a future update!",
                Duration = 3
            })
        end
    end
})

MainTab:AddButton({
    Title = "Clear All Timers",
    Description = "Reset all stronghold timers",
    Callback = function()
        for name, connection in pairs(timerConnections) do
            connection:Disconnect()
        end
        timerConnections = {}
        strongholds = {}
        
        for _, stronghold in pairs(CollectionService:GetTagged("Stronghold")) do
            onStrongholdAdded(stronghold)
        end
        
        Fluent:Notify({
            Title = "Timers Cleared",
            Content = "All stronghold timers have been reset",
            Duration = 3
        })
    end
})

-- Setup SaveManager and InterfaceManager
SaveManager:SetLibrary(Fluent)
SaveManager:SetFolder("StrongholdTimer/configs")

InterfaceManager:SetLibrary(Fluent)
InterfaceManager:SetFolder("StrongholdTimer")
InterfaceManager:BuildInterfaceSection(MainTab)

-- Build config section BEFORE loading
SaveManager:BuildConfigSection(MainTab)

local function initialize()
    for _, stronghold in pairs(CollectionService:GetTagged("Stronghold")) do
        onStrongholdAdded(stronghold)
    end
    
    CollectionService:GetInstanceAddedSignal("Stronghold"):Connect(onStrongholdAdded)
    CollectionService:GetInstanceRemovedSignal("Stronghold"):Connect(onStrongholdRemoved)
    
    RunService.Heartbeat:Connect(function()
        for name, _ in pairs(strongholds) do
            updateTimer(name)
        end
    end)
    
    if client.Events and client.Events.StrongholdComplete then
        client.Events.StrongholdComplete:Connect(function(inFortress)
            if inFortress then
                Fluent:Notify({
                    Title = "Stronghold Completed!",
                    Content = "Great job! The stronghold will reopen later.",
                    Duration = 5
                })
            end
        end)
    end
    
    Fluent:Notify({
        Title = "Stronghold Timer Active",
        Content = "Now tracking all stronghold timers!",
        Duration = 4
    })
end

-- Load saved configuration AFTER everything is set up
task.spawn(function()
    -- Wait a brief moment to ensure all UI elements are fully created
    task.wait(0.1)
    
    -- Attempt to load the last saved configuration
    local success, err = pcall(function()
        -- Try to load the default config file
        if SaveManager.LoadAutoloadConfig then
            SaveManager:LoadAutoloadConfig()
        else
            -- Fallback: try to load a config named "default" or the first available config
            local configs = SaveManager:GetConfigs()
            if configs and #configs > 0 then
                SaveManager:LoadConfig(configs[1])
            end
        end
    end)
    
    if success then
        Fluent:Notify({
            Title = "Config Loaded",
            Content = "Previous settings have been restored!",
            Duration = 3
        })
    else
        -- If loading fails, it's likely the first run or no config exists
        -- This is normal behavior, so we don't need to show an error
        print("No previous config found or failed to load:", err)
    end
end)

-- Initialize the main functionality
initialize()

return {
    Window = Window,
    GetStrongholds = function() return strongholds end,
    RefreshTimers = function()
        for name, _ in pairs(strongholds) do
            updateTimer(name)
        end
    end
}
